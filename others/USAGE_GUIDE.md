# Mathpix RAG 系统使用指南

## 一、快速开始

### 1. 环境配置

在 `.env.local` 文件中添加：

```bash
MATHPIX_APP_ID=your_app_id
MATHPIX_API_KEY=your_app_key
```

**获取 Mathpix API 密钥**：
1. 访问 https://console.mathpix.com
2. 注册/登录账户
3. 在组织页面获取 `app_id` 和 `app_key`

---

## 二、功能使用

### 2.1 上传 PDF 文件

**方法 1：拖拽上传**
1. 在左侧边栏的 "Documents" 区域
2. 将 PDF 文件拖拽到上传区域
3. 等待处理完成

**方法 2：点击上传**
1. 点击 "Select PDF" 按钮
2. 选择 PDF 文件
3. 等待处理完成

**处理进度**：
- 上传中 → 解析中 → 分块中 → 生成向量中 → 存储中 → 完成

---

### 2.2 引用文档

**步骤**：
1. 在消息输入框中输入 `#`
2. 会弹出文档选择器
3. 搜索并选择要引用的文档（支持多选）
4. 选中的文档会显示为标签

**示例**：
```
#file-123 What is machine learning?
```

**多文档引用**：
```
#file-123 #file-456 Compare these two documents
```

---

### 2.3 选择模型

**步骤**：
1. 在消息输入框中输入 `@`
2. 会弹出模型选择器
3. 选择要使用的模型

**示例**：
```
@gpt-5 #file-123 What is AI?
```

---

### 2.4 发送消息

**完整示例**：
```
@gpt-5 #file-123 #file-456 
What are the main differences between these two documents?
```

**系统会自动**：
1. 解析模型和文档引用
2. 检索相关文档块
3. 构建 RAG 上下文
4. 调用 LLM 生成回答
5. 显示回答和引用来源

---

## 三、UI 组件说明

### 3.1 侧边栏文件管理

**位置**：左侧边栏底部

**功能**：
- **上传区域**：拖拽或点击上传 PDF
- **文件列表**：显示已处理的文件
  - 文件名
  - 页数和块数
  - 处理时间
  - 删除按钮

---

### 3.2 Composer（消息输入框）

**功能**：
- **模型选择**：输入 `@` 选择模型
- **文档选择**：输入 `#` 选择文档
- **标签显示**：显示选中的模型和文档

**快捷键**：
- `Enter`：选择第一个选项（弹出框打开时）
- `Shift + Enter`：换行
- `Esc`：关闭弹出框

---

### 3.3 文档引用显示

**位置**：消息底部

**显示**：
- 引用的文档列表
- 可点击查看详情

---

## 四、工作流程

### 完整流程示例

1. **上传文档**
   ```
   用户上传 research-paper.pdf
   → 系统处理（解析、分块、向量化）
   → 文件出现在侧边栏列表
   ```

2. **引用文档提问**
   ```
   用户输入：@gpt-5 #research-paper What are the key findings?
   → 系统检索相关块
   → 构建上下文
   → 生成回答
   ```

3. **查看回答**
   ```
   AI 回答 + 引用来源显示
   ```

---

## 五、最佳实践

### 5.1 文档准备

- ✅ 使用清晰的 PDF 格式
- ✅ 确保文本可提取（非扫描版）
- ✅ 文件大小建议 < 50MB

### 5.2 提问技巧

- ✅ 明确具体的问题
- ✅ 引用相关文档
- ✅ 可以引用多个文档进行比较

### 5.3 性能优化

- ✅ 大文件处理需要时间，请耐心等待
- ✅ 处理进度会实时显示
- ✅ 可以同时处理多个文件

---

## 六、常见问题

### Q: 文件上传失败？
A: 检查：
- Mathpix API 密钥是否正确
- 文件格式是否为 PDF
- 网络连接是否正常

### Q: 文档选择器不显示？
A: 确保：
- 输入 `#` 在消息开头
- 已有处理完成的文件
- 当前线程有文件

### Q: RAG 检索不工作？
A: 检查：
- 文档是否处理完成
- IndexedDB 是否可用
- 浏览器控制台是否有错误

### Q: 向量生成很慢？
A: 
- 首次加载模型需要时间（~50MB）
- 模型会自动缓存
- 大文件需要更多时间

---

## 七、技术细节

### 7.1 处理流程

```
PDF 上传
  ↓
Mathpix API 解析（服务器端）
  ↓
文本分块（20% 重叠，客户端）
  ↓
向量生成（@xenova/transformers，浏览器端）
  ↓
存储到 IndexedDB（浏览器端）
  ↓
就绪，可用于检索
```

### 7.2 检索流程

```
用户提问 + 文档引用
  ↓
生成查询向量
  ↓
搜索相似块（余弦相似度）
  ↓
构建 RAG 上下文
  ↓
发送给 LLM
  ↓
生成回答
```

---

## 八、限制和注意事项

### 8.1 限制

- **文件大小**：建议 < 50MB
- **处理时间**：大文件可能需要几分钟
- **存储空间**：IndexedDB 通常支持 50MB - 1GB
- **Mathpix API**：有免费额度限制

### 8.2 注意事项

- 数据存储在浏览器本地，清除浏览器数据会丢失
- 不同设备之间不共享数据
- 需要网络连接（Mathpix API）

---

## 九、故障排除

### 9.1 检查清单

- [ ] Mathpix API 密钥配置正确
- [ ] 浏览器支持 IndexedDB
- [ ] 浏览器支持 Web Worker
- [ ] 网络连接正常
- [ ] 文件格式正确（PDF）

### 9.2 调试

打开浏览器控制台查看：
- 处理进度日志
- 错误信息
- 向量检索日志

---

## 十、更新日志

### v1.0.0
- ✅ 基础 PDF 处理功能
- ✅ 文档引用功能
- ✅ RAG 检索集成
- ✅ UI 组件完成


# UI é›†æˆè®¾è®¡æ–‡æ¡£

## ä¸€ã€æ•´ä½“è®¾è®¡

### 1.1 åŠŸèƒ½éœ€æ±‚

1. **æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†**
   - PDF æ–‡ä»¶ä¸Šä¼ 
   - å¤„ç†è¿›åº¦æ˜¾ç¤º
   - å¤„ç†çŠ¶æ€ç®¡ç†

2. **å·²å¤„ç†æ–‡ä»¶åˆ—è¡¨**
   - æ˜¾ç¤ºå½“å‰çº¿ç¨‹çš„æ‰€æœ‰å·²å¤„ç†æ–‡ä»¶
   - æ–‡ä»¶ä¿¡æ¯ï¼ˆåç§°ã€é¡µæ•°ã€å—æ•°ã€å¤„ç†æ—¶é—´ï¼‰
   - æ–‡ä»¶åˆ é™¤åŠŸèƒ½

3. **æ–‡æ¡£å¼•ç”¨ï¼ˆCitationï¼‰**
   - åœ¨ composer ä¸­ä½¿ç”¨ `#` è§¦å‘æ–‡æ¡£é€‰æ‹©å™¨
   - ç±»ä¼¼æ¨¡å‹é€‰æ‹©å™¨çš„äº¤äº’
   - æ”¯æŒå¤šæ–‡æ¡£é€‰æ‹©
   - åœ¨æ¶ˆæ¯ä¸­æ˜¾ç¤ºå¼•ç”¨çš„æ–‡æ¡£æ ‡ç­¾

4. **RAG é›†æˆ**
   - è‡ªåŠ¨æ£€ç´¢å¼•ç”¨çš„æ–‡æ¡£
   - å°†ç›¸å…³å—æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
   - åœ¨å›ç­”ä¸­æ˜¾ç¤ºå¼•ç”¨æ¥æº

---

## äºŒã€ç»„ä»¶è®¾è®¡

### 2.1 æ–‡ä»¶ä¸Šä¼ ç»„ä»¶

**ä½ç½®**ï¼šä¾§è¾¹æ æˆ–å¯¹è¯é¡µé¢é¡¶éƒ¨

**åŠŸèƒ½**ï¼š
- æ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»ä¸Šä¼ 
- æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
- å¤„ç†çŠ¶æ€ï¼ˆä¸Šä¼ ä¸­ â†’ å¤„ç†ä¸­ â†’ å®Œæˆï¼‰

**ç»„ä»¶**ï¼š`components/assistant-ui/file-upload-panel.tsx`

---

### 2.2 å·²å¤„ç†æ–‡ä»¶åˆ—è¡¨

**ä½ç½®**ï¼šä¾§è¾¹æ åº•éƒ¨æˆ–å¯¹è¯é¡µé¢ä¾§è¾¹

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
- æ–‡ä»¶ä¿¡æ¯å¡ç‰‡
- åˆ é™¤æŒ‰é’®
- ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

**ç»„ä»¶**ï¼š`components/assistant-ui/processed-files-panel.tsx`

---

### 2.3 æ–‡æ¡£é€‰æ‹©å™¨

**ä½ç½®**ï¼šComposer è¾“å…¥æ¡†ï¼ˆç±»ä¼¼æ¨¡å‹é€‰æ‹©å™¨ï¼‰

**è§¦å‘**ï¼šè¾“å…¥ `#` åœ¨æ¶ˆæ¯å¼€å¤´

**åŠŸèƒ½**ï¼š
- æœç´¢å·²å¤„ç†æ–‡ä»¶
- æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
- å¤šé€‰æ”¯æŒ
- æ˜¾ç¤ºé€‰ä¸­çš„æ–‡æ¡£æ ‡ç­¾

**ç»„ä»¶**ï¼š
- `components/document-mention/document-popover.tsx`
- `components/document-mention/document-tag.tsx`
- `components/document-mention/document-input.tsx`

---

### 2.4 æ–‡æ¡£å¼•ç”¨æ˜¾ç¤º

**ä½ç½®**ï¼šæ¶ˆæ¯ä¸­æ˜¾ç¤ºå¼•ç”¨çš„æ–‡æ¡£

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºå¼•ç”¨çš„æ–‡æ¡£æ ‡ç­¾
- ç‚¹å‡»æŸ¥çœ‹æ–‡æ¡£è¯¦æƒ…
- æ˜¾ç¤ºå¼•ç”¨æ¥æº

**ç»„ä»¶**ï¼š`components/assistant-ui/document-citation.tsx`

---

## ä¸‰ã€æ•°æ®ç»“æ„

### 3.1 æ–‡æ¡£å¼•ç”¨æ ¼å¼

```typescript
interface DocumentMention {
  fileId: string;
  fileName: string;
  chunkIds?: string[]; // å¯é€‰ï¼šç‰¹å®šå—
}

// åœ¨æ¶ˆæ¯ä¸­å­˜å‚¨
interface MessageWithDocuments {
  content: string;
  documents?: DocumentMention[]; // å¼•ç”¨çš„æ–‡æ¡£
  modelId?: string; // é€‰æ‹©çš„æ¨¡å‹
}
```

### 3.2 æ–‡æ¡£é€‰æ‹©å™¨çŠ¶æ€

```typescript
interface DocumentSelectorState {
  selectedDocuments: DocumentMention[];
  searchQuery: string;
  showPopover: boolean;
}
```

---

## å››ã€å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»ºæ–‡æ¡£é€‰æ‹©å™¨ç»„ä»¶

å‚è€ƒ `model-mention` çš„å®ç°ï¼Œåˆ›å»º `document-mention` ç»„ä»¶ã€‚

### æ­¥éª¤ 2ï¼šæ‰©å±• Composer

åœ¨ `ComposerWithMention` ä¸­æ·»åŠ æ–‡æ¡£é€‰æ‹©åŠŸèƒ½ã€‚

### æ­¥éª¤ 3ï¼šåˆ›å»ºæ–‡ä»¶ç®¡ç†é¢æ¿

æ˜¾ç¤ºå·²å¤„ç†æ–‡ä»¶åˆ—è¡¨ã€‚

### æ­¥éª¤ 4ï¼šé›†æˆåˆ°èŠå¤© API

åœ¨ `/api/chat/route.ts` ä¸­å¤„ç†æ–‡æ¡£å¼•ç”¨å’Œ RAG æ£€ç´¢ã€‚

---

## äº”ã€UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Thread Header                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Messages       â”‚  â”‚  File Panel  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  [Message 1]    â”‚  â”‚  ğŸ“„ file1.pdfâ”‚ â”‚
â”‚  â”‚  [Message 2]    â”‚  â”‚  ğŸ“„ file2.pdfâ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  [+ Upload]  â”‚ â”‚
â”‚  â”‚  â”‚ Composer    â”‚â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ #doc @model â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚  â”‚ [ğŸ“„] [ğŸ¤–]   â”‚â”‚                   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€äº¤äº’æµç¨‹

### 6.1 ä¸Šä¼ æ–‡ä»¶

1. ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æˆ–æ‹–æ‹½æ–‡ä»¶
2. æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
3. è°ƒç”¨ `processPDFToRAG`
4. æ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼ˆ5 ä¸ªé˜¶æ®µï¼‰
5. å®Œæˆåæ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨

### 6.2 å¼•ç”¨æ–‡æ¡£

1. ç”¨æˆ·åœ¨ composer ä¸­è¾“å…¥ `#`
2. æ˜¾ç¤ºæ–‡æ¡£é€‰æ‹©å™¨å¼¹å‡ºæ¡†
3. æœç´¢å’Œé€‰æ‹©æ–‡æ¡£
4. æ˜¾ç¤ºæ–‡æ¡£æ ‡ç­¾
5. æ”¯æŒå¤šé€‰

### 6.3 å‘é€æ¶ˆæ¯

1. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶é€‰æ‹©æ–‡æ¡£
2. ç‚¹å‡»å‘é€
3. ç³»ç»Ÿæ£€ç´¢å¼•ç”¨çš„æ–‡æ¡£
4. å°†ç›¸å…³å—æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
5. è°ƒç”¨ LLM ç”Ÿæˆå›ç­”
6. æ˜¾ç¤ºå›ç­”å’Œå¼•ç”¨æ¥æº

---

## ä¸ƒã€API é›†æˆ

### 7.1 æ‰©å±•èŠå¤©è¯·æ±‚

```typescript
type ChatRequestBody = {
  messages: UIMessage[];
  userStudyMode?: boolean;
  documentIds?: string[]; // å¼•ç”¨çš„æ–‡æ¡£ ID
};
```

### 7.2 RAG æ£€ç´¢æµç¨‹

```typescript
// åœ¨ /api/chat/route.ts ä¸­
if (documentIds && documentIds.length > 0) {
  // 1. æ£€ç´¢ç›¸å…³å—
  const relevantChunks = await retrieveChunksForDocuments(
    documentIds,
    userQuery,
    topK: 5
  );
  
  // 2. æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
  const enhancedMessage = {
    ...lastMessage,
    content: buildRAGContext(relevantChunks, userQuery),
  };
}
```

---

## å…«ã€è§†è§‰è®¾è®¡

### 8.1 æ–‡æ¡£æ ‡ç­¾æ ·å¼

- ç±»ä¼¼æ¨¡å‹æ ‡ç­¾
- æ˜¾ç¤ºæ–‡ä»¶å›¾æ ‡å’Œåç§°
- å¯ç‚¹å‡»åˆ é™¤

### 8.2 æ–‡ä»¶å¡ç‰‡æ ·å¼

- æ–‡ä»¶å›¾æ ‡
- æ–‡ä»¶å
- é¡µæ•°å’Œå—æ•°
- å¤„ç†æ—¶é—´
- åˆ é™¤æŒ‰é’®

### 8.3 å¼•ç”¨æ˜¾ç¤ºæ ·å¼

- åœ¨æ¶ˆæ¯åº•éƒ¨æ˜¾ç¤ºå¼•ç”¨
- å¯ç‚¹å‡»æŸ¥çœ‹æ¥æº
- é«˜äº®ç›¸å…³å—

